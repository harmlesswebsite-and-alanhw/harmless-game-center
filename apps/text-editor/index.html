<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title id="taitl">Text editor</title>
    <link rel="stylesheet" href="../../style.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="../../res/settings.js"></script>
</head>
<body>
    <div style="display: table; position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
    <div style="background-color: cyan; display: table-row; height: 0px;">
        <div style="display: table-cell; text-align: center;">
        <div style="float: left;"><button onclick="closeAllMessages(); document.getElementById('openfile').style.display = 'block'; document.getElementById('openfile').querySelector('input').focus();">Open...</button></div>
        <span id="currentTitle" style="text-align: center;">Harmless Text Editor</span>
        <div style="float: right;">Save...</div>
        </div>
    </div>
    <div id="editarea" style="display: table-row;">
    <label style="display: table-cell; padding: 5px;">
    <span style="position: fixed; top: -9999px;">File contents:</span>
    <textarea id="writehere" style="font-family: monospace;background-color: white; border: none; outline: none;width: 100%; height: 100%; display: block; padding: 0; border-radius: none;" spellcheck="false"></textarea>
    </label></div>
    <div class="status-bar" style="background-color: cyan; display: table-row; height: 0px;">
        <div style="display: table-cell;" id="status-bar">
        <div id="welcomemsg">Welcome.</div>
    <div id="openfile"><form action="javascript:;" onsubmit="location.hash = document.getElementById('file2open').value;"><label>Open file: <input id="file2open" size="20" /></label>
    <span style="float: right;">ENTER = Choose, ESC = cancel</span>
    </form></div>
    <div id="nope">Nope.</div>
    <div id="fileinfo">File <span id="filename">$FILENAME</span> currently open</div>
    <div id="filenotfound">Sorry. File <span id="nonexistentfilename">$FILENAME</span> not found</div>
    <div id="fileerror">Sorry. There was an error reading your file: <span id="fileerrortext">$ERROR</span></div>
    </div>
        </div>
        <script>
            globalThis.closed = true;
            window.addEventListener('hashchange', function() {
                // Since we have nodeIntegration: true, we can use
                // require directly here.
                globalThis.closed = false;
                const fs = require('fs');
                closeAllMessages();
                const file = document.getElementById('file2open').value;
                if (!fs.existsSync(file)) {
                    document.getElementById('nonexistentfilename').textContent = file;
                    return document.getElementById('filenotfound').style.display = 'block';
                }
                // Read file
                fs.readFile(file, function(error, data) {
                    if (error) {
                        document.getElementById('fileerrortext').textContent = error;
                        return document.getElementById('fileerror').style.display = 'block';
                    }
                    // CALLBACK HELL! 3 levels deep now!
                    fs.realpath(file, function(error, path) {
                        document.getElementById('filename').textContent = path;
                        document.getElementById('fileinfo').style.display = 'block';
                        fs.readFile(path, 'utf-8', function(err, data) {
                            // 4 levels now!
                            document.getElementById('writehere').value = data;
                        });
                    });
                });
            });
            function closeAllMessages() {
                var msgs = document.querySelectorAll('#status-bar > div');
                for (var i = 0; i < msgs.length; i++) msgs[i].style.display = 'none';
            }
            document.getElementById('file2open').addEventListener('keydown', function(ev) {
                if (ev.key === 'Escape') {
                    closeAllMessages();
                    document.getElementById('nope').style.display = 'block';
                }
            });
        </script>
    </div>